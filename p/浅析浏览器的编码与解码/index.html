<!doctype html><html lang=en-us>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="对浏览器编码原理的探索"><title>浅析浏览器的编码与解码</title>
<link rel=canonical href=https://sera.wang/p/%E6%B5%85%E6%9E%90%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E7%BC%96%E7%A0%81%E4%B8%8E%E8%A7%A3%E7%A0%81/>
<link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="浅析浏览器的编码与解码">
<meta property="og:description" content="对浏览器编码原理的探索">
<meta property="og:url" content="https://sera.wang/p/%E6%B5%85%E6%9E%90%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E7%BC%96%E7%A0%81%E4%B8%8E%E8%A7%A3%E7%A0%81/">
<meta property="og:site_name" content="Sera Wang">
<meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="浏览器"><meta property="article:published_time" content="2018-08-13T21:14:23+08:00"><meta property="article:modified_time" content="2018-08-13T21:14:23+08:00">
<meta name=twitter:title content="浅析浏览器的编码与解码">
<meta name=twitter:description content="对浏览器编码原理的探索">
<link rel="shortcut icon" href=https://ser4wang.oss-cn-beijing.aliyuncs.com/20211204221119.png>
</head>
<body class=article-page>
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"dark")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex
on-phone--column compact">
<aside class="sidebar left-sidebar sticky">
<button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box>
<span class=hamburger-inner></span>
</span>
</button>
<header class=site-info>
<figure class=site-avatar>
<img src=https://ser4wang.oss-cn-beijing.aliyuncs.com/20211204221119.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</figure>
<h1 class=site-name><a href=https://sera.wang>Sera Wang</a></h1>
<h2 class=site-description>Practice makes perfect.</h2>
</header>
<ol class=menu id=main-menu>
<li>
<a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span>
</a>
</li>
<li>
<a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span>
</a>
</li>
<li>
<a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span>
</a>
</li>
<li>
<a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span>
</a>
</li>
<li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span>
</li>
</ol>
</aside>
<div class="disqus markdown">
<div id=disqus_thread></div>
<script type=text/javascript>(function(){var a,b;if(window.location.hostname=="localhost")return;a=document.createElement('script'),a.type='text/javascript',a.async=!0,b='serawang',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=http://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
<main class="main full-width">
<article class=main-article>
<header class=article-header>
<div class=article-details>
<header class=article-category>
<a href=/categories/develop_notes/ style=background-color:#2a9d8f;color:#fff>
开发笔记
</a>
</header>
<h2 class=article-title>
<a href=/p/%E6%B5%85%E6%9E%90%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E7%BC%96%E7%A0%81%E4%B8%8E%E8%A7%A3%E7%A0%81/>浅析浏览器的编码与解码</a>
</h2>
<h3 class=article-subtitle>
对浏览器编码原理的探索
</h3>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Aug 13, 2018</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
1 min read
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<p>一直以来对url编码，html编码，js编码都存在着困惑，比如</p>
<ol>
<li>url/html/js是如何编码的?</li>
<li>浏览器又是什么时候按什么顺序进行url/html/js解码?</li>
</ol>
<p>读完了the tangled web，翻了些博客，又各种google，我想暂时可以解除一点心中的疑惑了。</p>
<h1 id=整体简述>整体简述</h1>
<hr>
<p>在开始之前，我想先简单说一下整体的一个过程:</p>
<ol>
<li>
<p>在浏览器的地址栏中输入url，发送http请求头(涉及tcp/ip/dns)</p>
<blockquote>
<p><a class=link href=http://example.com/test.php target=_blank rel=noopener>http://example.com/test.php</a></p>
</blockquote>
</li>
<li>
<p>远程的web服务器(apache/iis等)接收到url，分析请求头，根据它找到对应资源，返回一个响应头和数据</p>
</li>
<li>
<p>浏览器接收到响应的数据后，开始了接下来要讲的解析…</p>
</li>
</ol>
<h1 id=如何编码>如何编码</h1>
<hr>
<p>在开始解析前，我们先看看这些东西是如何编码的</p>
<ol>
<li>
<p>url编码:</p>
<p>标准的url结构是:</p>
<blockquote>
<p>scheme://login:password@address:port/path?quesry_string#fragment</p>
</blockquote>
<p>以之前那串url为栗</p>
<blockquote>
<p><a class=link href="http://example.com/test.php?uid=27&content=on#main" target=_blank rel=noopener>http://example.com/test.php?uid=27&content=on#main</a></p>
</blockquote>
<p>这是一串普通的url，即我们平常所见的格式大多和这个类似，也就是说，像开头的 “ http: “，协议后面跟一个冒号，还有之后的两个正斜杠” // “, 后面再跟域名，再跟地址，再跟参数字符串，再跟片段id…</p>
<p>可以看到，一些符号非常”常规”，比如冒号，正斜杠，问号…这些都是浏览器/服务器用来解析url用于语义分隔的保留字符，如果出现在url里就会破坏语法，影响正常解析，导致的各种有趣的后果以后有机会再讲。</p>
<p>于是就有了url编码，因为有些保留字符可能确实有必要需要在url里出现，<strong>它以一个百分号%和该字符的ASCII对应的2位十六进制数去替换这些字符</strong></p>
<p>比如，等于号=的url编码为 %3D</p>
</li>
<li>
<p>html编码</p>
<p>我们拿常见的标签举例，</p>
<blockquote>
</blockquote>
<p>跟url的问题类似，为了避免在标签内容中出现以及应对某些攻击，某些保留字符出现在文本节点和标签值里是不安全的，比如说多重标签，xss…</p>
<p>于是就有了html编码，一般以 <strong>&</strong> 开头，以分号 <strong>;</strong> 结尾，</p>
<blockquote>
<p>左尖括号 &lt; 写作 <code>&lt;</code></p>
<p>右尖括号 > 写作 <code>></code></p>
<p>& 写作 <code>&</code></p>
</blockquote>
<p>还可以插入以任意十进制ASCII码或Unicode字符编码，样式为</p>
<blockquote>
<p>&#数值;</p>
</blockquote>
<p>比如</p>
<blockquote>
<p>左尖括号 &lt; 写作 <code>&lt;</code></p>
<p>右尖括号 > 写作 <code>></code></p>
</blockquote>
</li>
<li>
<p>js编码</p>
<p>道理同上，js常见的反斜杠方式编码处理</p>
<ul>
<li>\b退格符，\t制表符，\v垂直制表符等</li>
<li>3位数字，不足位数用0补充，按8位原字符八进制字符编码，如 \145 代表 e</li>
<li>2位数字，不足位数用0补充，按8位原字符16进制字符编码，前缀 x ，如 \x65 代表 e</li>
<li>4位数字，不足为数用0补充，按16位原字符16进制Unicode数值编码，前缀 u ，如 \u0065 代表 e</li>
</ul>
</li>
</ol>
<h1 id=浏览器解码处理流>浏览器解码处理流</h1>
<hr>
<p>先说url的解析吧，浏览器接收时一般不需要对url进行解码处理，只有在发送后，服务器才需要对url进行解码来确定接收参数和定位资源。</p>
<p>讲完了url，我们开始接下来的部分</p>
<p>之前说到，浏览器接收到响应数据——一份html文档，下图展示了整个流程</p>
<p><img src=http://p6jpvwsnk.bkt.clouddn.com/18-8-13/66691532.jpg alt=img></p>
<p>先简单说一下整个过程，浏览器的HTML解析器先对HTML之类的文档进行解析，构建成DOM节点树，同时，CSS会被CSS解析器解析生成样式表，而JS解析器会对JS脚本进行解析，然后把脚本生成或改变的DOM节点映射到DOM树上，同时也通过CSSOM API映射到CSS样式表里，然后DOM树加上样式表一起渲染构建成框架树，再通过UI就绘制成了一般用户看到的界面了。</p>
<p>说的生动点，HTML和CSS两种面粉各自先揉成一团，然后用JS这根擀面棍逐一敲打，最后再把两个揉成一团，最后做成面条。（这可能是我讲例子的极限了…）</p>
<p><strong>那么，这当中我们目前最关心的解码都发生在什么过程中呢?</strong></p>
<p>先看一段html代码（为了方便，不严格遵从规范了）</p>
<pre tabindex=0><code>&lt;html&gt;
    &lt;h1&gt;Main Title&lt;/h1&gt;
    &lt;div class=&quot;content&quot;&gt;
        &lt;h2&gt;Second Title&lt;/h2&gt;
        &lt;p&gt;Content&lt;/p&gt;
    &lt;/div&gt;
&lt;/html&gt;
</code></pre><p>通过解析器的解析后，它生成了DOM树，长这样</p>
<p><img src=http://p6jpvwsnk.bkt.clouddn.com/18-8-13/84732141.jpg alt=img></p>
<p>如果修改一下，比如说把下面这段一部分用html编码</p>
<pre tabindex=0><code>&lt;h1&gt;Main Title&lt;/h1&gt; 
</code></pre><p>变成</p>
<pre tabindex=0><code>&lt;&amp;#104;1&gt;Main Title&lt;/h1&gt;
</code></pre><p>或者</p>
<pre tabindex=0><code>&lt;h1&gt;M&amp;#97;in T&amp;#105;tle&lt;/h1&gt;
</code></pre><p>感兴趣的不妨试一下，看看两者有什么区别</p>
<p>试过了之后，会发现前者没有了html标签的作用，后者是正常的，说到这里其实就可以明白一点html解码的时机了。</p>
<p><strong>它是在浏览器构建完DOM树以后才进行解码的</strong>，当解析器对前者(对标签进行html编码)进行解析时，无法识别为html标签，所以构建不了DOM节点，后者不同，于是成功构建了DOM节点。 而在解析器解析完后，就会进行html解码，于是两者都会解码显示。</p>
<p>接下来再来讲讲JS的编码与解码，不管是外部引用还是直接写在script标签里，又或者是在html标签的属性里，对于js编码的解码都是相同的，</p>
<p>同上，先来看一段js代码</p>
<pre tabindex=0><code>&lt;script&gt;
alert(&quot;Hello World&quot;);
&lt;/script&gt;
</code></pre><p>通过js编码变成</p>
<pre tabindex=0><code>&lt;script&gt;
\u0061lert(&quot;Hello World&quot;);
&lt;/script&gt;
</code></pre><p>或者</p>
<pre tabindex=0><code>&lt;script&gt;
alert(&quot;\u0048ello World&quot;);
&lt;/script&gt;
</code></pre><p>感兴趣的依旧可以试试看</p>
<p>我们发现，两者的效果是相同的，但还有一部分同学……收起你们奇怪的想法吧，如果想尝试将括号和引号进行类似转义，会导致失败，原因我没百度到，所以让我对js代码具体处理过程中怎么解析的产生了困惑。</p>
<p>我们知道，js的脚本处理模型是按照 源码处理-函数解析-代码执行这个执行流来的，每块代码都自成体系处理…所以可能需要看一下Gecko里是怎么处理的…而这个跟我们现在要讲的关系不大，日后再讨论吧！尽管我对此也充满了好奇！但是，先继续我们的内容吧。</p>
<p><strong>html和js各自的部分都讲完了，那两者”混合”起来是怎样做的呢?</strong></p>
<p>我们来看这段代码</p>
<pre tabindex=0><code>&lt;div id=&quot;content&quot;&gt;&lt;/div&gt;

&lt;img src=&quot;y.com&quot; onerror=&quot;alert(2)&quot;/&gt;
&lt;p&gt;Hello Parser!&lt;/p&gt;

&lt;script&gt;
var content = document.getElementById(&quot;content&quot;);
var img = document.createElement(&quot;img&quot;);
img.src    =    &quot;x.com&quot;;
img.setAttribute(&quot;onerror&quot;,&quot;&amp;#97;lert(1)&quot;);

content.appendChild(img);
&lt;/script&gt;
</code></pre><p>script脚本中改变了DOM节点树，最后按照顺序解析，先响应2后响应1，如果把script标签移到img标签之前，结果相反。</p>
<p>嗯这很正常，这说明浏览器是按一种顺序流执行解析的，也说明js对DOM树的影响是先于html解码器的。</p>
<p>也就是说可以下个结论，html解析完生成DOM树，js解析器会对js编码进行解码，然后对DOM树进行修改，最后修改完的DOM树再进行HTML解码。</p>
<p>至于怎么XSS就视各种情况见仁见智了。</p>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/>浏览器</a>
</section>
</footer>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>Related contents</h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article>
<a href=/p/what_powerdns_do/>
<div class=article-details>
<h2 class=article-title>【WIP】开源DNS服务器源码解析</h2>
</div>
</a>
</article>
<article>
<a href=/p/blackbox-scanner/>
<div class=article-details>
<h2 class=article-title>如何实现一个黑盒扫描器?</h2>
</div>
</a>
</article>
<article>
<a href=/p/java%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%9F%E7%90%86/>
<div class=article-details>
<h2 class=article-title>Java序列化与反序列化原理</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<div class=disqus-container>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//serawang.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
<style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style>
<script>window.addEventListener('onColorSchemeChange',a=>{DISQUS&&DISQUS.reset({reload:!0})})</script>
<footer class=site-footer>
<section class=copyright>
&copy;
2017 -
2021 Sera Wang
</section>
<section class=powerby>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=2.5.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a>
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>