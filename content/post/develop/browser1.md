---
title: "浅析浏览器的编码与解码"
description: 对浏览器编码原理的探索
date: 2018-08-13T21:14:23+08:00
tags:
    - 浏览器
---

一直以来对url编码，html编码，js编码都存在着困惑，比如

1. url/html/js是如何编码的?
2. 浏览器又是什么时候按什么顺序进行url/html/js解码?

读完了the tangled web，翻了些博客，又各种google，我想暂时可以解除一点心中的疑惑了。



# 整体简述

------

在开始之前，我想先简单说一下整体的一个过程:

1. 在浏览器的地址栏中输入url，发送http请求头(涉及tcp/ip/dns)

   > http://example.com/test.php

2. 远程的web服务器(apache/iis等)接收到url，分析请求头，根据它找到对应资源，返回一个响应头和数据

3. 浏览器接收到响应的数据后，开始了接下来要讲的解析…

# 如何编码

------

在开始解析前，我们先看看这些东西是如何编码的

1. url编码:

   标准的url结构是:

   > scheme://login:password@address:port/path?quesry_string#fragment

   以之前那串url为栗

   > http://example.com/test.php?uid=27&content=on#main

   这是一串普通的url，即我们平常所见的格式大多和这个类似，也就是说，像开头的 “ http: “，协议后面跟一个冒号，还有之后的两个正斜杠” // “, 后面再跟域名，再跟地址，再跟参数字符串，再跟片段id…

   可以看到，一些符号非常”常规”，比如冒号，正斜杠，问号…这些都是浏览器/服务器用来解析url用于语义分隔的保留字符，如果出现在url里就会破坏语法，影响正常解析，导致的各种有趣的后果以后有机会再讲。

   于是就有了url编码，因为有些保留字符可能确实有必要需要在url里出现，**它以一个百分号%和该字符的ASCII对应的2位十六进制数去替换这些字符**

   比如，等于号=的url编码为 %3D

2. html编码

   我们拿常见的标签举例，

   > <p>Hello World</p>

   跟url的问题类似，为了避免在标签内容中出现以及应对某些攻击，某些保留字符出现在文本节点和标签值里是不安全的，比如说多重标签，xss…

   于是就有了html编码，一般以 **&** 开头，以分号 **;** 结尾，

   > 左尖括号 < 写作 `<`
   >
   > 右尖括号 > 写作 `>`
   >
   > & 写作 `&`

   还可以插入以任意十进制ASCII码或Unicode字符编码，样式为

   > &#数值;

   比如

   > 左尖括号 < 写作 `<`
   >
   > 右尖括号 > 写作 `>`

3. js编码

   道理同上，js常见的反斜杠方式编码处理

   - \b退格符，\t制表符，\v垂直制表符等
   - 3位数字，不足位数用0补充，按8位原字符八进制字符编码，如 \145 代表 e
   - 2位数字，不足位数用0补充，按8位原字符16进制字符编码，前缀 x ，如 \x65 代表 e
   - 4位数字，不足为数用0补充，按16位原字符16进制Unicode数值编码，前缀 u ，如 \u0065 代表 e

# 浏览器解码处理流

------

先说url的解析吧，浏览器接收时一般不需要对url进行解码处理，只有在发送后，服务器才需要对url进行解码来确定接收参数和定位资源。

讲完了url，我们开始接下来的部分

之前说到，浏览器接收到响应数据——一份html文档，下图展示了整个流程

![img](http://p6jpvwsnk.bkt.clouddn.com/18-8-13/66691532.jpg)

先简单说一下整个过程，浏览器的HTML解析器先对HTML之类的文档进行解析，构建成DOM节点树，同时，CSS会被CSS解析器解析生成样式表，而JS解析器会对JS脚本进行解析，然后把脚本生成或改变的DOM节点映射到DOM树上，同时也通过CSSOM API映射到CSS样式表里，然后DOM树加上样式表一起渲染构建成框架树，再通过UI就绘制成了一般用户看到的界面了。

说的生动点，HTML和CSS两种面粉各自先揉成一团，然后用JS这根擀面棍逐一敲打，最后再把两个揉成一团，最后做成面条。（这可能是我讲例子的极限了…）

**那么，这当中我们目前最关心的解码都发生在什么过程中呢?**

先看一段html代码（为了方便，不严格遵从规范了）

```
<html>
    <h1>Main Title</h1>
    <div class="content">
        <h2>Second Title</h2>
        <p>Content</p>
    </div>
</html>
```

通过解析器的解析后，它生成了DOM树，长这样

![img](http://p6jpvwsnk.bkt.clouddn.com/18-8-13/84732141.jpg)

如果修改一下，比如说把下面这段一部分用html编码

```
<h1>Main Title</h1> 
```

变成

```
<&#104;1>Main Title</h1>
```

或者

```
<h1>M&#97;in T&#105;tle</h1>
```

感兴趣的不妨试一下，看看两者有什么区别

试过了之后，会发现前者没有了html标签的作用，后者是正常的，说到这里其实就可以明白一点html解码的时机了。

**它是在浏览器构建完DOM树以后才进行解码的**，当解析器对前者(对标签进行html编码)进行解析时，无法识别为html标签，所以构建不了DOM节点，后者不同，于是成功构建了DOM节点。 而在解析器解析完后，就会进行html解码，于是两者都会解码显示。

接下来再来讲讲JS的编码与解码，不管是外部引用还是直接写在script标签里，又或者是在html标签的属性里，对于js编码的解码都是相同的，

同上，先来看一段js代码

```
<script>
alert("Hello World");
</script>
```

通过js编码变成

```
<script>
\u0061lert("Hello World");
</script>
```

或者

```
<script>
alert("\u0048ello World");
</script>
```

感兴趣的依旧可以试试看

我们发现，两者的效果是相同的，但还有一部分同学……收起你们奇怪的想法吧，如果想尝试将括号和引号进行类似转义，会导致失败，原因我没百度到，所以让我对js代码具体处理过程中怎么解析的产生了困惑。

我们知道，js的脚本处理模型是按照 源码处理-函数解析-代码执行这个执行流来的，每块代码都自成体系处理…所以可能需要看一下Gecko里是怎么处理的…而这个跟我们现在要讲的关系不大，日后再讨论吧！尽管我对此也充满了好奇！但是，先继续我们的内容吧。

**html和js各自的部分都讲完了，那两者”混合”起来是怎样做的呢?**

我们来看这段代码

```
<div id="content"></div>

<img src="y.com" onerror="alert(2)"/>
<p>Hello Parser!</p>

<script>
var content = document.getElementById("content");
var img = document.createElement("img");
img.src    =    "x.com";
img.setAttribute("onerror","&#97;lert(1)");

content.appendChild(img);
</script>
```

script脚本中改变了DOM节点树，最后按照顺序解析，先响应2后响应1，如果把script标签移到img标签之前，结果相反。

嗯这很正常，这说明浏览器是按一种顺序流执行解析的，也说明js对DOM树的影响是先于html解码器的。

也就是说可以下个结论，html解析完生成DOM树，js解析器会对js编码进行解码，然后对DOM树进行修改，最后修改完的DOM树再进行HTML解码。

至于怎么XSS就视各种情况见仁见智了。